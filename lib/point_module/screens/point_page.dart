// lib/point_module/screens/point_page.dart

import 'dart:io';
import 'dart:async';
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:in_app_purchase/in_app_purchase.dart';
import 'package:intl/intl.dart';

import '../models/point_package.dart';
import '../services/payment_service.dart';
import '../services/android_payment_service.dart';
import '../services/ios_payment_service.dart';
import '../handlers/payment_handler.dart';
import '../widgets/point_header_widget.dart';
import '../widgets/charge_tab_view.dart';
import '../widgets/history_tab_view.dart';
import '../dialogs/charge_confirm_dialog.dart';

class PointPage extends StatefulWidget {
  final int initialTabIndex;

  const PointPage({
    super.key,
    this.initialTabIndex = 0,
  });

  @override
  State<PointPage> createState() => _PointPageState();
}

class _PointPageState extends State<PointPage> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  final NumberFormat _numberFormat = NumberFormat('#,###');
  int _currentPoints = 0;
  bool _isLoading = true;
  StreamSubscription<DocumentSnapshot>? _pointsSubscription;

  PaymentService? _paymentService;
  StreamSubscription<List<PurchaseDetails>>? _purchaseSubscription;
  bool _isPurchasing = false;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(
      length: 2,
      vsync: this,
      initialIndex: widget.initialTabIndex,
    );
    _loadUserPoints();
    _initializePayment();
  }

  @override
  void dispose() {
    _tabController.dispose();
    _purchaseSubscription?.cancel();
    _pointsSubscription?.cancel();
    _paymentService?.dispose();
    super.dispose();
  }

  Future<void> _initializePayment() async {
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser == null) {
      return;
    }

    if (Platform.isAndroid) {
      _paymentService = AndroidPaymentService();
    } else if (Platform.isIOS) {
      _paymentService = IOSPaymentService();
      // iOSÏùò Í≤ΩÏö∞ ÏÑúÎ≤Ñ Í≤ÄÏ¶ù ÏΩúÎ∞± ÏÑ§Ï†ï
      (_paymentService as IOSPaymentService).onPurchaseComplete = (success, message) {
        if (mounted) {
          setState(() {
            _isPurchasing = false;
          });

          if (success) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(message),
                backgroundColor: Colors.green,
              ),
            );
          } else {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(message),
                backgroundColor: Colors.red,
              ),
            );
          }
        }
      };
    } else {
      return;
    }

    final bool initialized = await _paymentService!.initialize();
    if (!initialized) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Í≤∞Ï†ú ÏÑúÎπÑÏä§Î•º Ï¥àÍ∏∞ÌôîÌï† Ïàò ÏóÜÏäµÎãàÎã§.'),
            backgroundColor: Colors.red,
          ),
        );
      }
      return;
    }

    _purchaseSubscription = _paymentService!.purchaseStream.listen((purchaseDetailsList) {
      _handlePurchaseUpdates(purchaseDetailsList);
    });
  }

  void _handlePurchaseUpdates(List<PurchaseDetails> purchaseDetailsList) async {
    for (PurchaseDetails purchaseDetails in purchaseDetailsList) {
      print('üì± Íµ¨Îß§ ÏÉÅÌÉú: ${purchaseDetails.status}, pending: ${purchaseDetails.pendingCompletePurchase}');

      // iOSÏóêÏÑú restoredÎäî Ïù¥ÎØ∏ ÌïÑÌÑ∞ÎßÅÎêòÏóàÏßÄÎßå, ÌòπÏãú Î™®Î•¥Îãà Ïó¨Í∏∞ÏÑúÎèÑ Ï≤¥ÌÅ¨
      if (purchaseDetails.status == PurchaseStatus.restored) {
        print('üì± restored Î¨¥ÏãúÎê®');
        continue;
      }

      if (purchaseDetails.status == PurchaseStatus.pending) {
        setState(() {
          _isPurchasing = true;
        });
      } else if (purchaseDetails.status == PurchaseStatus.error) {
        setState(() {
          _isPurchasing = false;
        });
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Í≤∞Ï†ú Ïò§Î•ò: ${purchaseDetails.error?.message ?? "Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò"}'),
              backgroundColor: Colors.red,
            ),
          );
        }
      } else if (purchaseDetails.status == PurchaseStatus.purchased) {
        // AndroidÏùò Í≤ΩÏö∞ÏóêÎßå Ïó¨Í∏∞ÏÑú Ï≤òÎ¶¨
        if (Platform.isAndroid) {
          try {
            await PaymentHandler.handleSuccessfulPurchase(purchaseDetails, _currentPoints);

            final package = PointPackage.packages.firstWhere(
                  (p) => p.androidProductId == purchaseDetails.productID ||
                  p.iosProductId == purchaseDetails.productID,
              orElse: () => PointPackage.packages.first,
            );

            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text('${_numberFormat.format(package.points)} Ìè¨Ïù∏Ìä∏Í∞Ä Ï∂©Ï†ÑÎêòÏóàÏäµÎãàÎã§.'),
                  backgroundColor: Colors.green,
                ),
              );
            }

            setState(() {
              _isPurchasing = false;
            });
          } catch (e) {
            setState(() {
              _isPurchasing = false;
            });
            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text('Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${e.toString()}'),
                  backgroundColor: Colors.red,
                ),
              );
            }
          }
        }
        // iOSÎäî IOSPaymentServiceÏùò ÏΩúÎ∞±ÏóêÏÑú Ï≤òÎ¶¨Îê®
      } else if (purchaseDetails.status == PurchaseStatus.canceled) {
        setState(() {
          _isPurchasing = false;
        });
        if (mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Í≤∞Ï†úÍ∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.'),
              backgroundColor: Colors.orange,
            ),
          );
        }
      }
    }
  }

  Future<void> _loadUserPoints() async {
    try {
      final currentUser = FirebaseAuth.instance.currentUser;
      if (currentUser == null) {
        setState(() {
          _isLoading = false;
          _currentPoints = 0;
        });
        return;
      }

      _pointsSubscription?.cancel();

      _pointsSubscription = FirebaseFirestore.instance
          .collection('users')
          .doc(currentUser.uid)
          .snapshots()
          .listen((snapshot) {
        if (snapshot.exists) {
          setState(() {
            _currentPoints = snapshot.data()?['points'] ?? 0;
            _isLoading = false;
          });
        } else {
          setState(() {
            _isLoading = false;
            _currentPoints = 0;
          });
        }
      }, onError: (error) {
        setState(() {
          _isLoading = false;
          _currentPoints = 0;
        });
      });
    } catch (e) {
      setState(() {
        _isLoading = false;
        _currentPoints = 0;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF9F9F9),
      appBar: AppBar(
        title: const Text(
          'Ìè¨Ïù∏Ìä∏',
          style: TextStyle(
            color: Colors.black,
            fontSize: 18,
            fontWeight: FontWeight.w600,
          ),
        ),
        backgroundColor: Colors.white,
        elevation: 0,
        iconTheme: const IconThemeData(color: Colors.black),
        bottom: PreferredSize(
          preferredSize: const Size.fromHeight(1),
          child: Container(
            color: const Color(0xFFEEEEEE),
            height: 1,
          ),
        ),
      ),
      body: Column(
        children: [
          PointHeaderWidget(
            currentPoints: _currentPoints,
            isLoading: _isLoading,
          ),
          Container(
            color: Colors.white,
            padding: const EdgeInsets.all(16),
            child: Container(
              height: 50,
              decoration: ShapeDecoration(
                color: const Color(0xFFF3F3F3),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
              ),
              child: TabBar(
                controller: _tabController,
                indicator: ShapeDecoration(
                  color: Colors.white,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(10),
                  ),
                ),
                indicatorSize: TabBarIndicatorSize.tab,
                indicatorPadding: const EdgeInsets.all(5),
                dividerColor: Colors.transparent,
                labelColor: const Color(0xFF4E5968),
                unselectedLabelColor: const Color(0xFF858585),
                labelStyle: const TextStyle(
                  color: Color(0xFF4E5968),
                  fontSize: 14,
                  fontFamily: 'Pretendard',
                  fontWeight: FontWeight.w600,
                ),
                unselectedLabelStyle: const TextStyle(
                  color: Color(0xFF858585),
                  fontSize: 14,
                  fontFamily: 'Pretendard',
                  fontWeight: FontWeight.w600,
                ),
                tabs: const [
                  Tab(text: 'Ìè¨Ïù∏Ìä∏ Ï∂©Ï†Ñ'),
                  Tab(text: 'ÏÇ¨Ïö© ÎÇ¥Ïó≠'),
                ],
              ),
            ),
          ),
          Container(
            color: const Color(0xFFF9F9F9),
            height: 10,
          ),
          Expanded(
            child: TabBarView(
              controller: _tabController,
              children: [
                ChargeTabView(
                  isPurchasing: _isPurchasing,
                  onChargePressed: _showChargeConfirmDialog,
                ),
                const HistoryTabView(),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _showChargeConfirmDialog(PointPackage package) {
    final currentUser = FirebaseAuth.instance.currentUser;
    if (currentUser == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Ìè¨Ïù∏Ìä∏ Ï∂©Ï†ÑÏùÑ ÏúÑÌï¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.'),
          backgroundColor: Colors.orange,
        ),
      );
      return;
    }

    ChargeConfirmDialog.show(
      context: context,
      package: package,
      points: _currentPoints,
      onConfirm: () => _purchasePoints(package),
    );
  }

  Future<void> _purchasePoints(PointPackage package) async {
    if (_paymentService == null) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Í≤∞Ï†ú ÏÑúÎπÑÏä§Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'),
            backgroundColor: Colors.orange,
          ),
        );
      }
      return;
    }

    setState(() {
      _isPurchasing = true;
    });

    try {
      final success = await _paymentService!.purchasePoints(package);
      if (!success && mounted) {
        setState(() {
          _isPurchasing = false;
        });
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Í≤∞Ï†úÎ•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      setState(() {
        _isPurchasing = false;
      });
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Í≤∞Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${e.toString()}'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }
}